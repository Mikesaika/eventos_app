<div class="container mt-4">
  
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="fw-bold">Gestión de Servicios</h2>
    
    <div class="d-flex gap-2">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar servicio..." 
          (keyup)="search(txtSearch)" 
          #txtSearch
        >
      </div>
      <button class="btn btn-primary text-nowrap d-flex align-items-center gap-2 shadow-sm" (click)="openNew()">
        <i class="bi bi-plus-lg"></i> Nuevo Servicio
      </button>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>Servicio</th>
            <th>Categoría</th>
            <th>Empresa</th>
            <th>Precio</th>
            <th>Clasificación</th>
            <th>Estado</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (s of services; track s.servicioID) {
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <img 
                    [src]="s.imagenURL" 
                    alt="img" 
                    class="rounded me-3 bg-light border" 
                    style="width: 50px; height: 50px; object-fit: cover;"
                    (error)="handleImageError($event)"
                  >
                  <div class="d-flex flex-column">
                    <span class="fw-bold text-dark">{{ s.nombre }}</span>
                    <small class="text-muted text-truncate" style="max-width: 200px;">{{ s.descripcion }}</small>
                  </div>
                </div>
              </td>
              
              <td><span class="text-secondary">{{ getCategoryName(s.categoriaID) }}</span></td>
              <td><span class="text-secondary">{{ getCompanyName(s.empresaID) }}</span></td>
              <td class="fw-bold text-dark">{{ s.precio | currency:'USD' }}</td>
              
              <td>
                <span class="badge rounded-pill px-3 py-2" 
                  [ngClass]="{
                    'bg-secondary-subtle text-secondary border border-secondary': s.clasificacion === 'plata',
                    'bg-warning-subtle text-warning-emphasis border border-warning': s.clasificacion === 'oro',
                    'bg-info-subtle text-info-emphasis border border-info': s.clasificacion === 'diamante'
                  }">
                  <i class="bi bi-award-fill me-1"></i> {{ s.clasificacion | titlecase }}
                </span>
              </td>

              <td>
                <span class="badge d-inline-flex align-items-center gap-1" [ngClass]="s.activo ? 'text-success bg-success-subtle' : 'text-danger bg-danger-subtle'">
                  <i class="bi" [ngClass]="s.activo ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
                  {{ s.activo ? 'Activo' : 'Inactivo' }}
                </span>
              </td>

              <td class="text-end">
                <div class="btn-group shadow-sm">
                  <button class="btn btn-sm btn-outline-primary" (click)="openEdit(s)" title="Editar">
                    <i class="bi bi-pencil-fill"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="delete(s)" title="Eliminar">
                    <i class="bi bi-trash-fill"></i>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                No se encontraron servicios registrados.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true" #serviceModalRef>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <div class="modal-header bg-primary text-white py-3">
        <h5 class="modal-title fw-bold">
          <i class="bi" [ngClass]="editingId ? 'bi-pencil-square' : 'bi-plus-circle'"></i>
          {{ editingId ? 'Editar Servicio' : 'Nuevo Servicio' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="modalRef.hide()"></button>
      </div>

      <form [formGroup]="formService" (ngSubmit)="save()">
        <div class="modal-body p-4">
          
          <div class="row mb-3">
            <div class="col-md-8">
              <label class="form-label fw-semibold">Nombre del Servicio <span class="text-danger">*</span></label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="nombre" 
                placeholder="Ej. Catering Premium"
                [class.is-invalid]="isFieldInvalid('nombre')"
              >
              <div class="invalid-feedback">
                @if (getFieldError('nombre', 'required')) { <span>El nombre es obligatorio.</span> }
                @if (getFieldError('nombre', 'maxlength')) { <span>Máximo 100 caracteres.</span> }
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-semibold">Precio <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input 
                  type="number" 
                  class="form-control" 
                  formControlName="precio"
                  [class.is-invalid]="isFieldInvalid('precio')"
                >
              </div>
              @if (isFieldInvalid('precio')) {
                <small class="text-danger">Ingrese un precio válido (mín. 0).</small>
              }
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Categoría <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="categoriaID" 
                [class.is-invalid]="isFieldInvalid('categoriaID')">
                <option value="">Seleccione una categoría...</option>
                @for (c of categories; track c.categoriaID) {
                  <option [value]="c.categoriaID">{{ c.nombre }}</option>
                }
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Empresa Proveedora <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="empresaID"
                [class.is-invalid]="isFieldInvalid('empresaID')">
                <option value="">Seleccione una empresa...</option>
                @for (co of companies; track co.empresaID) {
                  <option [value]="co.empresaID">{{ co.nombre }}</option>
                }
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Clasificación <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="clasificacion"
                [class.is-invalid]="isFieldInvalid('clasificacion')">
                <option value="">Seleccione...</option>
                <option value="plata">Plata</option>
                <option value="oro">Oro</option>
                <option value="diamante">Diamante</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label fw-semibold">URL de Imagen <span class="text-danger">*</span></label>
              <input type="text" class="form-control" formControlName="imagenURL" placeholder="https://ejemplo.com/foto.jpg"
                [class.is-invalid]="isFieldInvalid('imagenURL')">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Descripción <span class="text-danger">*</span></label>
            <textarea class="form-control" rows="3" formControlName="descripcion" 
              placeholder="Describa brevemente el servicio..."
              [class.is-invalid]="isFieldInvalid('descripcion')"></textarea>
          </div>

          <div class="form-check form-switch p-0 ms-4 mb-3">
            <input class="form-check-input" type="checkbox" formControlName="activo" id="checkActive">
            <label class="form-check-label fw-semibold" for="checkActive">
              Servicio disponible para clientes
            </label>
          </div>
        </div>

        <div class="modal-footer bg-light py-3">
          <button type="button" class="btn btn-outline-secondary px-4" (click)="modalRef.hide()">Cancelar</button>
          <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
            <i class="bi bi-save me-2"></i>
            {{ editingId ? 'Guardar Cambios' : 'Crear Servicio' }}
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<app-notification></app-notification>